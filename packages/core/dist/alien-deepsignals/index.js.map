{"version":3,"file":"index.js","names":["placeholder: Node | null","nodes: Node[]","lastInsertedNode: Node | null","element: ElementFromPrefixedTag<K>"],"sources":["../../src/alien-deepsignals/utils.ts","../../src/alien-deepsignals/index.ts"],"sourcesContent":["import { Computed, effect, isSignal } from \"alien-deepsignals\"\nimport type { AnyElement, Child } from \"../types\"\nimport type { ReactiveChild } from \"./types\"\nimport { childToNode, classkeys, handleAttribute, handleChildren } from \"../utils\"\n\nexport function handleSignalAttribute(element: AnyElement, key: string | symbol, value: any): void {\n    if (isSignal(value) || value instanceof Computed) {\n        effect(() => handleAttribute(element, key, value.get()))\n        return\n    }\n\n    if(typeof key === 'string') {\n        if(handleClassSignalAttribute(element, key, value)) return\n        if(handleStyleSignalAttribute(element, key, value)) return\n        if(handleDataSignalAttribute(element, key, value)) return\n    }\n\n    handleAttribute(element, key, value)\n}\n\nfunction handleClassSignalAttribute(element: AnyElement, name: string, value: any): boolean {\n    if (!classkeys.includes(name)) return false\n\n    if(Array.isArray(value)) {\n        effect(() => {\n            element.classList = ''\n\n            for (let v of value) {\n                if (isSignal(v) || v instanceof Computed) v = v.get()\n                if (v) element.classList.add(v)\n            }\n        })\n\n        return true\n    }\n\n    if(typeof value === 'object') {\n        for(const k of Object.keys(value)) {\n            effect(() => {\n                let v = value[k]\n                if ((isSignal(v) || v instanceof Computed)) v = v.get()\n                element.classList.toggle(k as string, v === true)\n            })\n        }\n\n        return true\n    }\n\n    return false\n}\n\nfunction handleStyleSignalAttribute(element: AnyElement, name: string, value: any): boolean {\n    if (name !== 'style') return false\n\n    if (typeof value === 'object' && value !== null) {\n        if(element instanceof SVGElement) {\n            effect(() => {\n                const styleString = Object.entries(value).map(([key, val]) => {\n                    const kebabKey = key.replace(/[A-Z]/g, match => `-${match.toLowerCase()}`);\n                    return `${kebabKey}: ${(isSignal(val) || val instanceof Computed ? val.get() : val)};`;\n                }).join('');\n                element.setAttribute('style', styleString);\n            })\n        } else {\n            for(const key of Object.keys(value)) {\n                effect(() => {\n                    let val = value[key]\n                    if (isSignal(val) || val instanceof Computed) val = val.get()\n                    // @ts-expect-error\n                    element.style[key] = val\n                })\n            }\n        }\n\n        return true\n    }\n\n    return false\n}\n\nfunction handleDataSignalAttribute(element: AnyElement, key: string, value: any): boolean {\n    if (key !== 'data') return false\n\n    if (typeof value === 'object' && value !== null) {\n        for(const k of Object.keys(value)) {\n            let v = value[k]\n            effect(() => {\n                if (isSignal(v) || v instanceof Computed) v = v.get()\n                if(typeof v === 'string') element.dataset[k] = v\n            })\n        }\n\n        return true\n    }\n\n    return false\n}\n\nexport function handleSignalChildren(element: AnyElement, children: Child | ReactiveChild): void {\n    if(isSignal(children) || children instanceof Computed) {\n        let placeholder: Node | null = null\n\n        const getPlaceholder = () => {\n            if (!placeholder) placeholder = document.createComment('signal placeholder')\n            return placeholder\n        }\n\n        const nodes: Node[] = []\n\n        effect(() => {\n            const newNodes = getNodes(children)\n            if (newNodes.length === 0) newNodes.push(getPlaceholder())\n\n            let lastInsertedNode: Node | null = null\n\n            for (let i = 0; i < Math.max(newNodes.length, nodes.length); i++) {\n                const newNode = newNodes[i]\n                const node = nodes[i]\n                const isInNew = node && newNodes.indexOf(node) !== -1\n\n                if (node && !isInNew && i + 1 < nodes.length) {\n                    if (element.contains(node)) element.removeChild(node)\n                    nodes.splice(i, 1)\n                    i--\n                    continue\n                }\n\n                if (newNode && newNode === node) {\n                    lastInsertedNode = newNode\n                    continue\n                }\n\n                if (newNode) {\n                    if (node && element.contains(node)) element.insertBefore(newNode, node)\n                    else if (lastInsertedNode && element.contains(lastInsertedNode)) insertAfter(element, newNode, lastInsertedNode)\n                    else element.appendChild(newNode)\n\n                    const indexInOld = nodes.indexOf(newNode)\n                    if (indexInOld !== -1) nodes.splice(indexInOld, 1)\n                    nodes.splice(i, 0, newNode)\n\n                    lastInsertedNode = newNode\n\n                    continue\n                }\n\n                if (!newNode && node) {\n                    for (let j = i; j < nodes.length; j++) {\n                        if (element.contains(nodes[j])) element.removeChild(nodes[j])\n                    }\n\n                    nodes.splice(i)\n                    break\n                }\n            }\n        })\n\n        return\n    }\n\n    handleChildren(element, children)\n}\n\nfunction getNodes(reactiveChild: ReactiveChild): Node[] {\n    const value = getReactiveChildValue(reactiveChild)\n\n    const nodes: Node[] = []\n    if (Array.isArray(value)) {\n        value.forEach((v) => {\n            const node = childToNode(v)\n            if (node) nodes.push(node)\n        })\n    } else {\n        const node = childToNode(value)\n        if (node) nodes.push(node)\n    }\n\n    return nodes\n}\n\nfunction getReactiveChildValue(child: ReactiveChild): Child | Child[] {\n    if (isSignal<Child | Child[]>(child)) return child.get()\n    if (child instanceof Computed) return child.get()\n\n    throw new Error(\"Invalid reactive child\")\n}\n\nfunction insertAfter(parent: Node, newNode: Node, referenceNode: Node): void {\n    const nextNode = referenceNode.nextSibling\n    if (nextNode) {\n        parent.insertBefore(newNode, nextNode)\n    } else {\n        parent.appendChild(newNode)\n    }\n}\n","import type { ElementFromPrefixedTag, PrefixedElementTag } from \"../types\"\nimport { handleSignalAttribute, handleSignalChildren } from \"./utils\";\nimport type { MayBeReactiveAttributes } from \"./types\";\n\nexport function el<K extends PrefixedElementTag>(tag: K, attributes?: MayBeReactiveAttributes<K> | null, ...children: NonNullable<MayBeReactiveAttributes<K>['children']>): ElementFromPrefixedTag<K> {\n    let element: ElementFromPrefixedTag<K>\n\n    if (tag === 'svg' || tag.startsWith('svg:')) {\n        element = document.createElementNS(\"http://www.w3.org/2000/svg\", tag === 'svg' ? 'svg' : tag.substring(4)) as ElementFromPrefixedTag<K>\n    } else if (tag === 'math' || tag.startsWith('math:')) {\n        element = document.createElementNS(\"http://www.w3.org/1998/Math/MathML\", tag === 'math' ? 'math' : tag.substring(5)) as ElementFromPrefixedTag<K>\n    } else {\n        element = document.createElement(tag) as ElementFromPrefixedTag<K>\n    }\n\n    if(attributes) {\n        for (let key of Reflect.ownKeys(attributes)) {\n            if (key === 'children') {\n                    attributes.children?.flat().forEach((child) => handleSignalChildren(element, child))\n            } else {\n                handleSignalAttribute(element, key, attributes[key])\n            }\n        }\n    }\n\n    children.flat().forEach((child) => handleSignalChildren(element, child))\n\n    return element\n}\n"],"mappings":"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"}